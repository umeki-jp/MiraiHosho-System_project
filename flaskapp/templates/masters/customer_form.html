{% extends "form_page_base.html" %}
{% set page_title = mode == "edit" and "顧客詳細" or "新規 顧客登録" %}

{# ============================================================================== #}
{# このブロックに、表示するボタンのロジックをすべて一度だけ定義します。 #}
{# ============================================================================== #}
{% block left_buttons %}
  {# ---------------------------------------------------------------- #}
  {# 詳細画面 (編集モード) のボタン #}
  {# ---------------------------------------------------------------- #}
  {% if mode == "edit" %}
    <input type="hidden" name="customer_code" value="{{ form_data.customer_code or '' }}">
    
    {% if approval_request %}
      <input type="hidden" name="approval_request_id" value="{{ approval_request.id }}">
    {% endif %}

    {# ▼▼▼【ここが重要な修正点】▼▼▼ #}
    {# 顧客ステータスが「2: 承認待ち」の場合と、それ以外（登録済、差戻し等）の場合で、表示するボタンのセットを明確に分けます。 #}

    {# --- ステータスが「2: 承認待ち」の場合の専用ボタン --- #}
    {% if form_data.registration_status == 2 %}

        {# --- 承認者の場合 --- #}
        {% if button_config.show_approve %}
            <button type="submit" name="action" value="approve" class="form-action-btn btn-success">承認する</button>
            <button type="submit" name="action" value="reject" class="form-action-btn btn-danger">差戻し</button>
        
        {# --- 申請者・管理者の場合 --- #}
        {% elif button_config.show_withdraw %}
            <button type="submit" name="action" value="withdraw_request" class="form-action-btn btn-warning">取下げ</button>
        {% endif %}
        
        <button type="button" class="form-action-btn btn-negative" onclick="window.close();">閉じる</button>

    {# --- 通常時（登録済、差戻しなど）のボタン --- #}
    {% else %}
        {% if button_config.show_instant_update %}
          <button type="submit" name="action" value="update_instant" class="form-action-btn">更新</button>
        {% endif %}
        {% if button_config.show_approval_update %}
          <button type="submit" name="action" value="request_update_approval" class="form-action-btn">更新申請</button>
        {% endif %}
        
        <div class="vr mx-2"></div>
        
        {% if button_config.show_instant_delete %}
          <button type="submit" name="action" value="delete_instant" class="form-action-btn btn-negative">削除</button>
        {% endif %}
        {% if button_config.show_approval_delete %}
          <button type="submit" name="action" value="request_delete_approval" class="form-action-btn btn-negative">削除申請</button>
        {% endif %}
        
        <button type="button" class="form-action-btn btn-negative" onclick="window.close();">閉じる</button>
    {% endif %}

  {# ---------------------------------------------------------------- #}
  {# 新規登録画面のボタン #}
  {# ---------------------------------------------------------------- #}
  {% else %}
    {% if button_config.show_instant_register %}
      <button type="submit" name="action" value="register_instant" class="form-action-btn">登録</button>
    {% endif %}
    <div class="vr mx-2"></div>
    {% if button_config.show_approval_register %}
      <button type="submit" name="action" value="request_new_approval" class="form-action-btn">登録申請</button>
    {% endif %}
    <button type="button" class="form-action-btn btn-negative" onclick="window.close();">登録せず閉じる</button>
  {% endif %}
{% endblock %}

{# ============================================================================== #}
{# メインコンテンツ部分。フォームの入力欄を読み込み、下部にもボタンを再表示します。 #}
{# ============================================================================== #}
{% block main_content %}

  {# --- 承認待ちや差戻しのメッセージ表示エリア --- #}
  {% if approval_request %}
    {# --- 差戻し(status=2)の場合 --- #}
    {% if approval_request.status == 2 %}
      <div class="alert alert-danger mb-4" role="alert">
        <h5 class="alert-heading">差戻し</h5>
        <p class="mb-0">この申請は差戻されました。内容を修正して再度、更新申請を行ってください。</p>
      </div>
    {# --- 承認待ち(status=0)の場合 --- #}
    {% elif approval_request.status == 0 %}
      <div class="alert alert-warning mb-4" role="alert">
        <h5 class="alert-heading">承認待ち</h5>
        <p>この顧客情報は現在、以下の内容で承認待ちです。</p>
        <hr>
        <div class="row">
          <div class="col-md-5">
              <strong>申請種別:</strong> {{ approval_request.request_type }} <br>
              <strong>申請者:</strong> {{ approval_request.requester_name }} (ID: {{ approval_request.requester_id }})<br>
              <strong>承認者:</strong> {{ approval_request.approver_name }} (ID: {{ approval_request.approver_id }})
          </div>
          <div class="col-md-7">
              {% if approval_request.changes %}
              <table class="table table-bordered table-sm" style="background-color: #fff6e9;">
                  <thead>
                      <tr>
                          <th style="width: 30%;">項目</th>
                          <th style="width: 35%;">変更前</th>
                          <th style="width: 35%;">変更後</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for change in approval_request.changes %}
                      <tr>
                          <td>{{ change.label }}</td>
                          <td class="text-muted">{{ change.before or '' }}</td>
                          <td><strong>{{ change.after or '' }}</strong></td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
              {% endif %}
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  {% include "masters/customer_form_partial.html" %}
  
  <div class="form-action-btns mt-4">
    {{ self.left_buttons() }}
  </div>
{% endblock %}