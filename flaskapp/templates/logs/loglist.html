{# flaskapp/templates/logs/loglist.html #}

{% extends "base.html" %}
{% set page_title = "行動履歴一覧" %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <ul class="nav nav-tabs card-header-tabs">
                {# target_type_mapを使って、存在する履歴タイプのタブを動的に生成します #}
                {% for type_id, type_name in target_type_map.items() %}
                    {% if type_id != 0 %} {# "未設定"は表示しない #}
                    <li class="nav-item">
                        <a class="nav-link {% if type_id == current_target_type %}active{% endif %}" 
                           href="{{ url_for('logs.show_loglist', target=type_id) }}">
                            {{ type_name }}
                        </a>
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
        <div class="card-header">
            <h3>{{ target_type_map.get(current_target_type, '不明') }} の行動履歴</h3>
        </div>
        <div class="card-body">
            <table class="table table-sm table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>日時</th>
                        <th>対象ID</th>
                        <th>操作者</th>
                        <th>発生源</th>
                        <th>操作</th>
                        <th>詳細</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.log_timestamp.strftime('%Y-%m-%d %H:%M:%S') if log.log_timestamp }}</td>
                        <td>{{ log.target_id }}</td>
                        <td>{{ log.shain_name }}</td>
                        <td>{{ action_source_map.get(log.action_source, '不明') }}</td>
                        <td>{{ action_type_map.get(log.action_type, '不明') }}</td>
                        <td>
                            {# action_details の内容を整形して表示 #}
                            {% if log.action_details_dict %}
                                {% if log.action_type == 2 %} {# 更新の場合 #}
                                    <ul class="list-unstyled mb-0">
                                    {% for change in log.action_details_dict %}
                                        <li>
                                            <strong>{{ change.label }}:</strong>
                                            <span class="text-muted">{{ change.before }}</span> →
                                            <span class="text-success">{{ change.after }}</span>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                {% elif log.action_details_dict.message %}
                                    {{ log.action_details_dict.message }}
                                {% elif log.action_details_dict.deleted_data %}
                                    削除されました。
                                {% else %}
                                    <pre style="white-space: pre-wrap; word-break: break-all; margin: 0; font-size: 0.8em;">{{ log.action_details }}</pre>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center">履歴はありません。</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}